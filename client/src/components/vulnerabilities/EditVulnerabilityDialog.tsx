import { useState, useEffect } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { AlertTriangle, Trash2, Sparkles } from "lucide-react";
import CvssCalculator from "@/components/cvss/CvssCalculator";
import MarkdownEditor from "@/components/markdown/MarkdownEditor";
import DynamicFieldList from "@/components/shared/DynamicFieldList";

interface Vulnerability {
  id?: string;
  title: string;
  description: string;
  severity: string;
  cvssScore?: number;
  cvssVector?: string;
  cveId?: string;
  cweId?: string;
  targetId?: string;
  operationId?: string;
  proofOfConcept?: string;
  remediation?: string;
  references?: string[];
  status?: string;
}

interface Target {
  id: string;
  name: string;
  type: string;
  value: string;
}

interface EditVulnerabilityDialogProps {
  open: boolean;
  vulnerability?: Vulnerability;
  targets: Target[];
  onClose: () => void;
  onSave: (vulnerability: Vulnerability) => void;
  onDelete?: (id: string) => void;
}

export default function EditVulnerabilityDialog({
  open,
  vulnerability,
  targets,
  onClose,
  onSave,
  onDelete,
}: EditVulnerabilityDialogProps) {
  const [formData, setFormData] = useState<Vulnerability>({
    title: "",
    description: "",
    severity: "medium",
    status: "open",
    references: [""],
  });
  const [remediationSteps, setRemediationSteps] = useState<string[]>([""]);
  const [aiAssisting, setAiAssisting] = useState(false);

  // Initialize form when dialog opens or vulnerability changes
  useEffect(() => {
    if (vulnerability) {
      setFormData({
        ...vulnerability,
        references: vulnerability.references || [""],
      });
      // Parse remediation into steps if it's a string
      if (vulnerability.remediation) {
        try {
          const parsed = JSON.parse(vulnerability.remediation);
          setRemediationSteps(Array.isArray(parsed) ? parsed : [vulnerability.remediation]);
        } catch {
          setRemediationSteps([vulnerability.remediation]);
        }
      } else {
        setRemediationSteps([""]);
      }
    } else {
      setFormData({
        title: "",
        description: "",
        severity: "medium",
        status: "open",
        references: [""],
      });
      setRemediationSteps([""]);
    }
  }, [vulnerability, open]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    // Clean up references and remediation (remove empty values)
    const cleanReferences = formData.references?.filter((r) => r.trim() !== "") || [];
    const cleanRemediation = remediationSteps.filter((s) => s.trim() !== "");
    
    onSave({
      ...formData,
      references: cleanReferences,
      remediation: JSON.stringify(cleanRemediation),
    });
  };

  const handleDelete = () => {
    if (vulnerability?.id && onDelete) {
      if (confirm("Are you sure you want to delete this vulnerability?")) {
        onDelete(vulnerability.id);
      }
    }
  };

  const handleCvssChange = (vector: string, score: number) => {
    setFormData((prev) => ({
      ...prev,
      cvssVector: vector,
      cvssScore: Math.round(score * 10), // Store as integer (e.g., 7.5 => 75)
    }));
  };

  const handleAiAssist = async () => {
    setAiAssisting(true);
    try {
      // TODO: Call Tavily MCP via agent
      // For now, provide mock data
      const mockData = {
        description: formData.cveId 
          ? `This vulnerability (${formData.cveId}) allows attackers to exploit the system through various attack vectors. Detailed analysis shows that this security flaw can lead to unauthorized access and potential data exposure.`
          : `This weakness (${formData.cweId}) represents a common security flaw in software development. Proper input validation and security controls should be implemented to mitigate this risk.`,
        severity: "high",
        cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        cvssScore: 90, // 9.0
        remediation: [
          "Apply the latest security patches",
          "Implement input validation and sanitization",
          "Enable security controls and monitoring",
        ],
        references: [
          `https://nvd.nist.gov/vuln/detail/${formData.cveId || formData.cweId}`,
          "https://cwe.mitre.org/data/definitions/",
        ],
      };

      // Auto-populate the form
      setFormData((prev) => ({
        ...prev,
        description: prev.description || mockData.description,
        severity: mockData.severity,
        cvssVector: mockData.cvssVector,
        cvssScore: mockData.cvssScore,
        references: mockData.references,
      }));

      setRemediationSteps(mockData.remediation);
      
      alert("AI populated vulnerability fields successfully! Review and adjust as needed.");
    } catch (error) {
      console.error("AI Assist error:", error);
      alert("Failed to auto-populate fields. Please try again.");
    } finally {
      setAiAssisting(false);
    }
  };

  const isEditing = !!vulnerability?.id;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5" />
            {isEditing ? "Edit Vulnerability" : "Add Vulnerability"}
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Basic Information */}
          <div className="space-y-4">
            <div>
              <Label htmlFor="title">Title *</Label>
              <Input
                id="title"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                placeholder="SQL Injection in Login Form"
                required
              />
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label htmlFor="target">Target</Label>
                <Select
                  value={formData.targetId || ""}
                  onValueChange={(value) => setFormData({ ...formData, targetId: value })}
                >
                  <SelectTrigger id="target">
                    <SelectValue placeholder="Select target..." />
                  </SelectTrigger>
                  <SelectContent>
                    {targets.map((target) => (
                      <SelectItem key={target.id} value={target.id}>
                        {target.name} ({target.type}: {target.value})
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="severity">Severity *</Label>
                <Select
                  value={formData.severity}
                  onValueChange={(value) => setFormData({ ...formData, severity: value })}
                >
                  <SelectTrigger id="severity">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="critical">Critical</SelectItem>
                    <SelectItem value="high">High</SelectItem>
                    <SelectItem value="medium">Medium</SelectItem>
                    <SelectItem value="low">Low</SelectItem>
                    <SelectItem value="informational">Informational</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="status">Status *</Label>
                <Select
                  value={formData.status || "open"}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger id="status">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="open">Open</SelectItem>
                    <SelectItem value="investigating">Investigating</SelectItem>
                    <SelectItem value="remediated">Remediated</SelectItem>
                    <SelectItem value="accepted">Accepted Risk</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="cve">CVE ID</Label>
                <Input
                  id="cve"
                  value={formData.cveId || ""}
                  onChange={(e) => setFormData({ ...formData, cveId: e.target.value })}
                  placeholder="CVE-2024-12345"
                />
              </div>

              <div>
                <Label htmlFor="cwe">CWE ID</Label>
                <Input
                  id="cwe"
                  value={formData.cweId || ""}
                  onChange={(e) => setFormData({ ...formData, cweId: e.target.value })}
                  placeholder="CWE-79"
                />
              </div>
            </div>

            {/* AI Assist Button */}
            {(formData.cveId || formData.cweId) && (
              <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                <div className="flex items-center justify-between">
                  <div>
                    <h4 className="text-sm font-semibold text-gray-900 mb-1">AI Auto-Population</h4>
                    <p className="text-xs text-gray-600">
                      Use AI to fetch and populate vulnerability details from public databases
                    </p>
                  </div>
                  <Button
                    type="button"
                    onClick={handleAiAssist}
                    disabled={aiAssisting || (!formData.cveId && !formData.cweId)}
                    className="bg-purple-600 hover:bg-purple-700"
                  >
                    <Sparkles className="h-4 w-4 mr-2" />
                    {aiAssisting ? "Fetching..." : "AI Assist"}
                  </Button>
                </div>
              </div>
            )}
          </div>

          {/* Description with Markdown */}
          <div>
            <Label className="text-sm font-medium mb-2 block">Description *</Label>
            <MarkdownEditor
              value={formData.description}
              onChange={(value) => setFormData({ ...formData, description: value })}
              placeholder="Detailed description of the vulnerability..."
              rows={6}
            />
          </div>

          {/* CVSS Calculator */}
          <CvssCalculator
            value={formData.cvssVector}
            onChange={handleCvssChange}
          />

          {/* Vulnerability References */}
          <DynamicFieldList
            label="Vulnerability References"
            values={formData.references || [""]}
            onChange={(values) => setFormData({ ...formData, references: values })}
            placeholder="https://cve.mitre.org/..."
            maxFields={3}
          />

          {/* Remediation Steps */}
          <DynamicFieldList
            label="Remediation Steps"
            values={remediationSteps}
            onChange={setRemediationSteps}
            placeholder="Apply security patch KB12345"
            maxFields={3}
          />

          {/* Proof of Concept */}
          <div>
            <Label htmlFor="poc">Proof of Concept</Label>
            <Textarea
              id="poc"
              value={formData.proofOfConcept || ""}
              onChange={(e) => setFormData({ ...formData, proofOfConcept: e.target.value })}
              placeholder="Steps to reproduce the vulnerability..."
              rows={6}
            />
          </div>

          {/* Dialog Footer with Actions */}
          <DialogFooter className="flex justify-between items-center">
            <div className="flex-1">
              {isEditing && onDelete && (
                <Button
                  type="button"
                  variant="destructive"
                  onClick={handleDelete}
                >
                  <Trash2 className="h-4 w-4 mr-1" />
                  Delete
                </Button>
              )}
            </div>
            <div className="flex gap-2">
              <Button type="button" variant="outline" onClick={onClose}>
                Cancel
              </Button>
              <Button type="submit">
                {isEditing ? "Save Changes" : "Add Vulnerability"}
              </Button>
            </div>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
