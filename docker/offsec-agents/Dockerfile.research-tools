# RTPI OffSec Agent: Research Tools (Optimized)
# General R&D, Tool Testing, POC Creation, and Knowledge Curation
#
# Categories: All-purpose security research, experimentation, documentation
# Primary Focus: Searchsploit, OSINT scripting, payload reference
#
# Tools removed (available in other containers):
#   - msfconsole → rtpi-tools
#   - nuclei, httpx, gobuster, bbot → rtpi-tools
#   - ffuf, gobuster, feroxbuster, subfinder, dnsx, amass, dirsearch → fuzzing-tools
#   - katana, nikto → burp-tools
#   - wpscan, testssl.sh → framework-tools
#   - pwntools, angr, radare2 → maldev-tools
#   - PEASS-ng, LaZagne, impacket → empire-tools
#   - sqlmap, rustscan → removed per user request

FROM rtpi/offsec-base:latest

# Set agent type for MCP server
ENV AGENT_TYPE=research
ENV TOOLS_PATH=/opt/tools

# Switch to root for package installation
USER root

# Install research dependencies (slimmed - removed pandoc, texlive)
RUN apt-get update && apt-get install -y \
    # Development tools
    build-essential cmake pkg-config \
    # Scripting languages
    python3 python3-pip ruby perl \
    # Network tools
    nmap masscan netcat-openbsd socat tcpdump wireshark-common tshark \
    # Binary analysis
    binutils binwalk \
    # Web tools
    curl wget httpie \
    # Version control
    git subversion \
    # Database clients
    postgresql-client mysql-client redis-tools \
    # Container tools
    docker.io \
    # Misc utilities
    jq tmux screen htop \
    && rm -rf /var/lib/apt/lists/*

# Install yq binary manually
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then YQ_ARCH="arm64"; else YQ_ARCH="amd64"; fi && \
    wget -q "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_${YQ_ARCH}" -O /usr/local/bin/yq && \
    chmod +x /usr/local/bin/yq

# Install Python research packages (slimmed - removed binary analysis, data science, docs)
RUN pip3 install --no-cache-dir \
    # Web
    requests httpx aiohttp beautifulsoup4 scrapy \
    # Network
    scapy \
    # Crypto
    pycryptodome cryptography \
    # Automation
    fabric invoke

# Install Python security tools (bbot for recon, dirsearch for path discovery)
RUN pip3 install --no-cache-dir bbot dirsearch

# Switch back to root for tool installation
USER root
WORKDIR /opt/tools

# =============================================================================
# EXPLOIT DATABASE (unique to this container)
# =============================================================================

# ExploitDB - Exploit database + searchsploit
RUN git clone --depth 1 https://gitlab.com/exploit-database/exploitdb.git && \
    echo "exploitdb: Exploit database and searchsploit" > exploitdb/TOOL_INFO.txt

# =============================================================================
# WORDLISTS & PAYLOADS
# =============================================================================

# Wordlists are synced from Cloudflare R2 at runtime via sync-wordlists.sh
RUN mkdir -p /opt/wordlists/SecLists

# PayloadsAllTheThings
RUN git clone --depth 1 https://github.com/swisskyrepo/PayloadsAllTheThings.git && \
    echo "PayloadsAllTheThings: Payload reference" > PayloadsAllTheThings/TOOL_INFO.txt

# =============================================================================
# CREATE SYMLINKS FOR TOOL DISCOVERY
# =============================================================================

# Make searchsploit discoverable via PATH
RUN ln -sf /opt/tools/exploitdb/searchsploit /usr/local/bin/searchsploit && \
    chmod +x /opt/tools/exploitdb/searchsploit 2>/dev/null || true

# =============================================================================
# CREATE RESEARCH WORKSPACE
# =============================================================================

RUN mkdir -p /home/rtpi-agent/research/{projects,experiments,notes,pocs,findings}

# =============================================================================
# CLEANUP AND PERMISSIONS
# =============================================================================

# Set ownership (much faster now - only exploitdb + PayloadsAllTheThings)
RUN chown -R rtpi-agent:rtpi-agent /opt/tools /opt/wordlists /home/rtpi-agent

# Generate tool documentation
RUN /usr/local/bin/generate-docs.sh || true

# Create tool index for MCP discovery
RUN find /opt/tools -name "TOOL_INFO.txt" -exec cat {} \; > /docs/TOOLS_INDEX.md

# Fix /docs permissions so entrypoint can regenerate docs at runtime
RUN chown -R rtpi-agent:rtpi-agent /docs

# Create research README
RUN cat > /home/rtpi-agent/research/README.md << 'EOF'
# Research Workspace

## Directories

- **projects/** - Active research projects
- **experiments/** - Experimental code and tests
- **notes/** - Research notes and documentation
- **pocs/** - Proof-of-concept implementations
- **findings/** - Documented findings and reports

## Quick Start

1. Create a new project: `mkdir -p projects/my-project`
2. Access tools via MCP: Use the MCP server to list and execute tools

## MCP Integration

All tools in /opt/tools are exposed via the MCP server.
Use `list_tools` to see available tools.
Use `get_tool_help` for detailed usage information.

## Cross-Container Tools

Most security tools are available in dedicated containers and routed
by the multi-container-executor. This container focuses on:
- searchsploit (ExploitDB)
- bbot (recon)
- dirsearch (path discovery)
- Python scripting (requests, scapy, beautifulsoup4, scrapy)
- PayloadsAllTheThings reference
EOF

# Switch to non-root user
USER rtpi-agent
WORKDIR /home/rtpi-agent

# Build MCP server
WORKDIR /mcp
RUN npm run build

# Expose MCP port
EXPOSE 9000

# Health check - verify container is alive
HEALTHCHECK --interval=60s --timeout=10s --retries=3 \
    CMD ["true"]

# Start MCP server
ENTRYPOINT ["/usr/local/bin/mcp-entrypoint.sh"]
