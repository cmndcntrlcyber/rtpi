# v2.4.1 Enhancement: Research Agent - Tavily MCP Integration

## Objective

Integrate the **research-agent** with Tavily MCP for deep vulnerability research when no known Metasploit module exists for a discovered vulnerability. The research-agent gathers exploit intelligence and feeds it to the maldev-agent for custom exploit development.

## Current State

- The Operation Lead phase uses **SearchSploit** (local Exploit-DB search) as the only vulnerability research tool
- A basic Tavily REST API integration was added in v2.3 to run alongside SearchSploit during the Operation Lead phase
- The `rtpi-research-agent` container is defined (`docker/offsec-agents/Dockerfile.research-tools`) but has no Tavily integration
- The agent message bus (`server/services/agent-message-bus.ts`) supports inter-agent task routing

## Enhancement Scope

### 1. Research Agent Tavily Task Handler

When the Operation Lead determines no known Metasploit module exists for a discovered vulnerability, it sends a research task via the agent message bus:

```typescript
// Message from Operation Lead to Research Agent
{
  type: "vulnerability_research",
  from: "operation-lead",
  to: "research-agent",
  payload: {
    targetId: "uuid",
    targetValue: "192.168.1.142",
    service: "Apache 2.4.49",
    port: 80,
    protocol: "tcp",
    knownCVEs: [], // Empty if none found by SearchSploit
    searchSploitResults: "...", // Raw SearchSploit output
    operationId: "uuid",
    objective: "Identify exploitable vulnerabilities and gather PoC code"
  }
}
```

### 2. Research Agent Tavily Workflow

The research-agent performs a multi-phase research pipeline:

**Phase 1 - CVE Discovery:**
- `tavily_search`: `"{service} {version} CVE vulnerability"`
- `tavily_search`: `"{service} {version} remote code execution exploit"`
- Parse CVE identifiers from results

**Phase 2 - Exploit Intelligence:**
- `tavily_search`: `"CVE-XXXX-XXXXX exploit PoC proof of concept"`
- `tavily_extract`: Extract full PoC code from GitHub repos, exploit-db, PacketStorm
- `tavily_search`: `"CVE-XXXX-XXXXX metasploit module"` (check if one exists we missed)

**Phase 3 - Attack Methodology:**
- `tavily_search`: `"{vulnerability} exploitation methodology walkthrough"`
- Gather attack prerequisites, payloads, and post-exploitation guidance

### 3. Research Output Format

```typescript
interface VulnerabilityResearchPackage {
  targetId: string;
  service: string;
  vulnerabilities: Array<{
    cve: string;
    severity: "critical" | "high" | "medium" | "low";
    description: string;
    affectedVersions: string;
    exploitAvailable: boolean;
    pocUrls: string[];
    pocCode?: string; // Extracted PoC source code
    attackVector: string; // network, local, adjacent
    prerequisites: string[];
  }>;
  exploitMethodology: string; // AI-synthesized attack plan
  metasploitModuleExists: boolean;
  recommendedApproach: "existing_module" | "custom_exploit" | "nuclei_template";
  sources: string[]; // All URLs consulted
}
```

### 4. Routing to Maldev Agent

If `recommendedApproach` is `"custom_exploit"` or `"nuclei_template"`, the research package is forwarded to the maldev-agent via the message bus for custom exploit development (see v2.4.2).

If a known Metasploit module is discovered during research, the package is returned to the Operation Lead to update the execution plan.

## Files to Create/Modify

| File | Action |
|------|--------|
| `server/services/agents/research-agent.ts` | **New** - Research agent extending BaseTaskAgent |
| `server/services/agent-workflow-orchestrator.ts` | Modify - Add research fallback when no modules found |
| `server/services/agent-message-bus.ts` | Modify - Register research-agent message handlers |
| `docker/offsec-agents/Dockerfile.research-tools` | Modify - Add tavily-mcp to container |

## Dependencies

- `TAVILY_API_KEY` environment variable configured
- Agent message bus operational
- `rtpi-research-agent` container running (or direct API mode)

## Success Criteria

1. When SearchSploit returns no exploits for a discovered service, the research-agent automatically performs deep web research
2. CVE identifiers are correctly extracted and validated
3. PoC code is extracted from source URLs when available
4. Research packages are correctly routed to maldev-agent when custom exploit development is needed
5. Full audit trail of research queries logged to workflow logs
