# v2.4.2 Enhancement: Maldev Agent - Custom Exploit Development

## Objective

Enable the **maldev-agent** to receive vulnerability research from the research-agent and craft custom exploitation artifacts (Metasploit modules, Nuclei templates, reverse shell payloads) targeting specific vulnerabilities for a given target within a given operation.

For network targets, **establishing a reverse shell via Metasploit multi/handler** is the primary objective.

## Current State

- The `rtpi-maldev-agent` container is defined (`docker/offsec-agents/Dockerfile.maldev-tools`) with 44 security tool repositories:
  - Reverse engineering: Ghidra MCP, Binary Analysis MCPs, x64dbg, WinDbg, RAVERSE
  - ROP development: RustChain, ROPgadget, ropium
  - Payload development: Shellcode-IDE, Packer, DarkLnk, hypervinject-poc
  - Evasion: TamperETW, SHAPESHIFTER, SharpCall, SysWhispers, reflective loaders
- The tool connector agent (`server/services/agents/tool-connector-agent.ts`) already discovers maldev container tools
- Nuclei template storage exists in the database (`nucleiTemplates` table in `shared/schema.ts`)
- The web-hacker-agent already generates custom Nuclei templates using AI (`server/services/agents/web-hacker-agent.ts`)

## Enhancement Scope

### 1. Maldev Agent Task Handler

The maldev-agent receives a task via the agent message bus containing:

```typescript
interface ExploitDevelopmentTask {
  type: "exploit_development";
  from: "research-agent";
  payload: {
    targetId: string;
    targetValue: string; // IP address or hostname
    operationId: string;
    ports: number[];
    services: Array<{ port: number; service: string; version: string }>;
    os: string;
    vulnerabilityResearch: VulnerabilityResearchPackage; // From research-agent
    objective: "reverse_shell" | "data_exfil" | "persistence";
    listenerConfig: {
      lhost: string; // Attacker IP
      lport: number; // Listener port
      handler: "multi/handler"; // Metasploit handler
    };
  };
}
```

### 2. Exploit Development Pipeline

**Phase 1 - Vulnerability Analysis:**
- Parse the research package to identify the most exploitable vulnerability
- Analyze PoC code structure, language, and delivery mechanism
- Determine exploit type: buffer overflow, injection, deserialization, etc.
- Identify target architecture (x86, x64, ARM) from OS/service info

**Phase 2 - Exploit Crafting:**

For **Metasploit modules** (.rb):
- Use AI inference (Claude/GPT) to generate a Metasploit module based on:
  - PoC code from research package
  - Target service/version information
  - Standard Metasploit module template structure
- Module includes:
  - Proper metadata (name, description, author, references, CVE)
  - `check` method for vulnerability verification
  - `exploit` method with payload delivery
  - Payload compatibility declaration (reverse_tcp, reverse_https)
- Configure for **Metasploit multi/handler** reverse shell delivery:
  ```
  PAYLOAD: <os>/meterpreter/reverse_tcp (or platform-appropriate)
  LHOST: <attacker_ip>
  LPORT: <listener_port>
  ```

For **Nuclei templates** (.yaml):
- Generate YAML template following Nuclei template syntax
- Include matchers for vulnerability confirmation
- Include extractors for data retrieval
- Store in `nucleiTemplates` table with `isCustom: true`, `generatedByAi: true`

**Phase 3 - Payload Generation:**
- Select appropriate payload for target OS:
  - Linux: `linux/x64/meterpreter/reverse_tcp`
  - Windows: `windows/x64/meterpreter/reverse_tcp`
  - macOS: `osx/x64/meterpreter/reverse_tcp`
- Configure multi/handler listener parameters
- Apply evasion techniques if target has known defenses (using container tools: TamperETW, SHAPESHIFTER, etc.)

### 3. Output Format

```typescript
interface ExploitArtifact {
  targetId: string;
  operationId: string;
  vulnerability: {
    cve: string;
    service: string;
    description: string;
  };
  artifacts: Array<{
    type: "metasploit_module" | "nuclei_template" | "standalone_exploit";
    name: string;
    content: string; // Ruby source for MSF, YAML for Nuclei
    filePath?: string; // If written to disk
    metadata: {
      targetPlatform: string;
      payloadType: string;
      reliability: "high" | "medium" | "low";
      evasionTechniques: string[];
    };
  }>;
  handlerConfig: {
    module: "exploit/multi/handler";
    payload: string;
    lhost: string;
    lport: number;
    additionalOptions: Record<string, string>;
  };
  executionInstructions: string; // AI-generated step-by-step guide
}
```

### 4. Integration with Workflow

The exploit artifact is returned to the **Senior Cyber Operator** phase of the penetration test workflow:

1. Maldev-agent sends completed artifact via message bus
2. Workflow orchestrator receives artifact in the exploitation phase
3. Senior Cyber Operator loads custom module into Metasploit:
   - Write `.rb` file to Metasploit modules directory
   - `reload_all` in msfconsole
   - `use <custom_module_path>`
   - Set handler options (LHOST, LPORT, PAYLOAD)
   - Execute the exploit
4. Results are captured and passed to the Technical Writer for reporting

### 5. Safety Controls

- All generated exploits are scoped to the target operation only
- Artifacts are tagged with operation ID and target ID for audit
- Custom modules are stored in an isolated directory, not mixed with stock modules
- Execution requires the target to be in-scope for the active operation
- All exploit development activity is logged to workflow logs

## Files to Create/Modify

| File | Action |
|------|--------|
| `server/services/agents/maldev-agent.ts` | **New** - Maldev agent extending BaseTaskAgent |
| `server/services/agent-workflow-orchestrator.ts` | Modify - Accept custom exploit artifacts in exploitation phase |
| `server/services/metasploit-executor.ts` | Modify - Support loading custom modules from file path |
| `server/services/agent-message-bus.ts` | Modify - Register maldev-agent message handlers |
| `shared/schema.ts` | Modify - Add `customExploits` table if needed for artifact storage |

## Dependencies

- Research-agent operational (v2.4.1)
- `rtpi-maldev-agent` container running with tools available
- Metasploit framework accessible for custom module loading
- AI provider configured (Anthropic or OpenAI) for exploit code generation

## Success Criteria

1. Maldev-agent receives vulnerability research and produces a functional Metasploit module
2. Custom module correctly targets the identified vulnerability
3. Reverse shell payload is configured for Metasploit multi/handler
4. Module can be loaded into Metasploit and executed against the target
5. Nuclei templates are stored in database and executable by the web-hacker-agent
6. Full audit trail of exploit development logged to workflow and operation
7. End-to-end flow: discovery -> research -> exploit development -> execution -> reporting
