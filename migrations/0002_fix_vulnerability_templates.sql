-- Migration: Fix vulnerability templates (corrected version)
-- Created: 2025-11-14
-- Description: Properly adds vulnerability templates support with correct SQL syntax

-- Step 1: Create vulnerability_templates table FIRST (before adding FK)
CREATE TABLE IF NOT EXISTS vulnerability_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  category TEXT NOT NULL,
  description TEXT NOT NULL,
  severity severity NOT NULL,
  cvss_vector TEXT,
  cwe_id TEXT,
  remediation_template TEXT,
  poc_template TEXT,
  impact_template TEXT,
  exploitability_template TEXT,
  tags JSONB DEFAULT '[]',
  "references" JSONB DEFAULT '[]',  -- Quoted because it's a reserved keyword
  is_active BOOLEAN NOT NULL DEFAULT true,
  usage_count INTEGER NOT NULL DEFAULT 0,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Step 2: Add columns to vulnerabilities table
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS template_id UUID REFERENCES vulnerability_templates(id);
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS status TEXT NOT NULL DEFAULT 'open';
ALTER TABLE vulnerabilities ADD COLUMN IF NOT EXISTS ai_generated JSONB DEFAULT '{}';

-- Step 3: Create vulnerability_versions table
CREATE TABLE IF NOT EXISTS vulnerability_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vulnerability_id UUID NOT NULL REFERENCES vulnerabilities(id) ON DELETE CASCADE,
  data JSONB NOT NULL,
  changed_by UUID REFERENCES users(id),
  change_description TEXT,
  change_type TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Step 4: Create indexes
CREATE INDEX IF NOT EXISTS idx_vulnerability_templates_category ON vulnerability_templates(category);
CREATE INDEX IF NOT EXISTS idx_vulnerability_templates_is_active ON vulnerability_templates(is_active);
CREATE INDEX IF NOT EXISTS idx_vulnerability_templates_created_by ON vulnerability_templates(created_by);
CREATE INDEX IF NOT EXISTS idx_vulnerability_versions_vuln_id ON vulnerability_versions(vulnerability_id);
CREATE INDEX IF NOT EXISTS idx_vulnerability_versions_changed_by ON vulnerability_versions(changed_by);
CREATE INDEX IF NOT EXISTS idx_vulnerability_versions_created_at ON vulnerability_versions(created_at);

-- Step 5: Insert seed data for common vulnerability templates
INSERT INTO vulnerability_templates (title, category, description, severity, cwe_id, remediation_template, poc_template, tags)
SELECT * FROM (VALUES
  (
    'SQL Injection',
    'web',
    'SQL Injection vulnerability allows attackers to interfere with database queries, potentially accessing, modifying, or deleting data.',
    'high'::severity,
    'CWE-89',
    E'1. Implement parameterized queries/prepared statements\n2. Use stored procedures with parameterized inputs\n3. Apply input validation and sanitization\n4. Implement least privilege database access\n5. Use ORM frameworks with built-in protection',
    E'## Proof of Concept\n\n1. Identify input field vulnerable to SQL injection\n2. Test with basic payload: '' OR ''1''=''1\n3. Enumerate database structure using UNION-based injection\n4. Extract sensitive data\n\n**Testing Steps:**\n```sql\n'' OR 1=1--\nUNION SELECT NULL, table_name FROM information_schema.tables--\n```',
    '["OWASP Top 10", "Web Security", "Database"]'::JSONB
  ),
  (
    'Cross-Site Scripting (XSS)',
    'web',
    'Cross-Site Scripting vulnerability allows attackers to inject malicious scripts into web pages viewed by other users.',
    'medium'::severity,
    'CWE-79',
    E'1. Implement output encoding/escaping for all user input\n2. Use Content Security Policy (CSP) headers\n3. Enable HTTPOnly and Secure flags on cookies\n4. Validate and sanitize all input\n5. Use modern frameworks with built-in XSS protection',
    E'## Proof of Concept\n\n1. Identify input field without proper encoding\n2. Inject test payload: <script>alert(''XSS'')</script>\n3. Verify script execution in browser\n4. Demonstrate impact (cookie theft, session hijacking)\n\n**Example Payloads:**\n```html\n<script>alert(document.cookie)</script>\n<img src=x onerror=alert(''XSS'')>\n```',
    '["OWASP Top 10", "Web Security", "Client-Side"]'::JSONB
  ),
  (
    'Command Injection',
    'web',
    'Command Injection vulnerability allows attackers to execute arbitrary system commands on the server.',
    'critical'::severity,
    'CWE-78',
    E'1. Avoid system calls when possible\n2. Use safe APIs that don''t invoke shell\n3. Implement strict input validation\n4. Use allowlists for acceptable inputs\n5. Apply principle of least privilege\n6. Escape shell metacharacters',
    E'## Proof of Concept\n\n1. Identify input passed to system commands\n2. Test with command chaining: ; whoami\n3. Execute commands: & dir or | ls\n4. Demonstrate system access\n\n**Test Payloads:**\n```bash\n; whoami\n& netstat -an\n| cat /etc/passwd\n```',
    '["OWASP Top 10", "Web Security", "Remote Code Execution"]'::JSONB
  ),
  (
    'Insecure Direct Object Reference (IDOR)',
    'web',
    'IDOR vulnerability allows attackers to access objects belonging to other users by manipulating reference parameters.',
    'medium'::severity,
    'CWE-639',
    E'1. Implement proper access control checks\n2. Use indirect object references (mapping)\n3. Validate user authorization for each request\n4. Apply session-based access controls\n5. Log and monitor access attempts',
    E'## Proof of Concept\n\n1. Identify object reference parameter (e.g., user_id, doc_id)\n2. Access resource with your valid ID\n3. Modify parameter to another user''s ID\n4. Verify unauthorized access to other user''s data\n\n**Example:**\n```\nGET /api/document?id=123 (your document)\nGET /api/document?id=456 (another user''s document - unauthorized access)\n```',
    '["OWASP Top 10", "Web Security", "Access Control"]'::JSONB
  ),
  (
    'Server-Side Request Forgery (SSRF)',
    'web',
    'SSRF vulnerability allows attackers to make requests from the server to internal or external resources.',
    'high'::severity,
    'CWE-918',
    E'1. Implement allowlist of permitted domains/IPs\n2. Disable unused URL schemas (file://, gopher://)\n3. Validate and sanitize all URLs\n4. Use network segmentation\n5. Implement response validation\n6. Disable HTTP redirections',
    E'## Proof of Concept\n\n1. Identify URL parameter processed by server\n2. Test internal network access: http://localhost:80\n3. Attempt cloud metadata access: http://169.254.169.254/\n4. Demonstrate access to internal resources\n\n**Test URLs:**\n```\nhttp://localhost:6379/\nhttp://169.254.169.254/latest/meta-data/\nfile:///etc/passwd\n```',
    '["OWASP Top 10", "Web Security", "Network"]'::JSONB
  )
) AS v(title, category, description, severity, cwe_id, remediation_template, poc_template, tags)
WHERE NOT EXISTS (SELECT 1 FROM vulnerability_templates WHERE vulnerability_templates.title = v.title);
