import { Router } from "express";
import { db } from "../../db";
import { vulnerabilityTemplates, vulnerabilities } from "@shared/schema";
import { eq, like, and } from "drizzle-orm";
import { ensureAuthenticated, ensureRole, logAudit } from "../../auth/middleware";

const router = Router();

// Apply authentication to all routes
router.use(ensureAuthenticated);

// GET /api/v1/vulnerability-templates - List all templates
router.get("/", async (req, res) => {
  try {
    const { category, search, activeOnly = "true" } = req.query;

    let query = db.select().from(vulnerabilityTemplates);

    // Filter by category
    if (category && typeof category === "string") {
      query = query.where(eq(vulnerabilityTemplates.category, category)) as any;
    }

    // Filter active only
    if (activeOnly === "true") {
      query = query.where(eq(vulnerabilityTemplates.isActive, true)) as any;
    }

    let templates = await query;

    // Search filter (client-side for simplicity)
    if (search && typeof search === "string") {
      const searchLower = search.toLowerCase();
      templates = templates.filter(
        (t) =>
          t.title.toLowerCase().includes(searchLower) ||
          t.description.toLowerCase().includes(searchLower)
      );
    }

    res.json({ templates });
  } catch (error) {
    console.error("List vulnerability templates error:", error);
    res.status(500).json({ error: "Failed to list vulnerability templates" });
  }
});

// GET /api/v1/vulnerability-templates/:id - Get template details
router.get("/:id", async (req, res) => {
  const { id } = req.params;

  try {
    const template = await db
      .select()
      .from(vulnerabilityTemplates)
      .where(eq(vulnerabilityTemplates.id, id))
      .limit(1)
      .then((rows) => rows[0]);

    if (!template) {
      return res.status(404).json({ error: "Template not found" });
    }

    res.json({ template });
  } catch (error) {
    console.error("Get vulnerability template error:", error);
    res.status(500).json({ error: "Failed to get vulnerability template" });
  }
});

// POST /api/v1/vulnerability-templates - Create new template
router.post("/", ensureRole("admin", "operator"), async (req, res) => {
  const user = req.user as any;

  try {
    const template = await db
      .insert(vulnerabilityTemplates)
      .values({
        ...req.body,
        createdBy: user.id,
      })
      .returning();

    await logAudit(user.id, "create_vulnerability_template", "/vulnerability-templates", template[0].id, true, req);

    res.status(201).json({ template: template[0] });
  } catch (error) {
    console.error("Create vulnerability template error:", error);
    await logAudit(user.id, "create_vulnerability_template", "/vulnerability-templates", null, false, req);
    res.status(500).json({ error: "Failed to create vulnerability template" });
  }
});

// PUT /api/v1/vulnerability-templates/:id - Update template
router.put("/:id", ensureRole("admin", "operator"), async (req, res) => {
  const { id } = req.params;
  const user = req.user as any;

  try {
    const template = await db
      .update(vulnerabilityTemplates)
      .set({
        ...req.body,
        updatedAt: new Date(),
      })
      .where(eq(vulnerabilityTemplates.id, id))
      .returning();

    if (!template || template.length === 0) {
      return res.status(404).json({ error: "Template not found" });
    }

    await logAudit(user.id, "update_vulnerability_template", "/vulnerability-templates", id, true, req);

    res.json({ template: template[0] });
  } catch (error) {
    console.error("Update vulnerability template error:", error);
    await logAudit(user.id, "update_vulnerability_template", "/vulnerability-templates", id, false, req);
    res.status(500).json({ error: "Failed to update vulnerability template" });
  }
});

// DELETE /api/v1/vulnerability-templates/:id - Delete template (soft delete by setting isActive = false)
router.delete("/:id", ensureRole("admin"), async (req, res) => {
  const { id } = req.params;
  const user = req.user as any;

  try {
    // Soft delete by setting isActive to false
    await db
      .update(vulnerabilityTemplates)
      .set({ isActive: false, updatedAt: new Date() })
      .where(eq(vulnerabilityTemplates.id, id));

    await logAudit(user.id, "delete_vulnerability_template", "/vulnerability-templates", id, true, req);

    res.json({ message: "Template deactivated successfully" });
  } catch (error) {
    console.error("Delete vulnerability template error:", error);
    await logAudit(user.id, "delete_vulnerability_template", "/vulnerability-templates", id, false, req);
    res.status(500).json({ error: "Failed to delete vulnerability template" });
  }
});

// POST /api/v1/vulnerability-templates/:id/instantiate - Create vulnerability from template
router.post("/:id/instantiate", ensureRole("admin", "operator"), async (req, res) => {
  const { id } = req.params;
  const { targetId, operationId, customizations } = req.body;
  const user = req.user as any;

  try {
    // Get template
    const template = await db
      .select()
      .from(vulnerabilityTemplates)
      .where(eq(vulnerabilityTemplates.id, id))
      .limit(1)
      .then((rows) => rows[0]);

    if (!template) {
      return res.status(404).json({ error: "Template not found" });
    }

    // Create vulnerability from template
    const newVuln = await db
      .insert(vulnerabilities)
      .values({
        title: customizations?.title || template.title,
        description: template.description,
        severity: template.severity,
        cvssVector: template.cvssVector || undefined,
        cweId: template.cweId || undefined,
        remediation: template.remediationTemplate || undefined,
        proofOfConcept: template.pocTemplate || undefined,
        impact: template.impactTemplate || undefined,
        exploitability: template.exploitabilityTemplate || undefined,
        references: template.references || [],
        targetId: targetId || undefined,
        operationId: operationId || undefined,
        templateId: template.id,
        ...customizations,
      })
      .returning();

    // Increment usage count
    await db
      .update(vulnerabilityTemplates)
      .set({
        usageCount: (template.usageCount || 0) + 1,
        updatedAt: new Date(),
      })
      .where(eq(vulnerabilityTemplates.id, id));

    await logAudit(user.id, "instantiate_template", "/vulnerability-templates", id, true, req);

    res.status(201).json({
      success: true,
      vulnerability: newVuln[0],
      message: "Vulnerability created from template",
    });
  } catch (error) {
    console.error("Instantiate template error:", error);
    await logAudit(user.id, "instantiate_template", "/vulnerability-templates", id, false, req);
    res.status(500).json({ error: "Failed to create vulnerability from template" });
  }
});

// GET /api/v1/vulnerability-templates/categories/list - Get list of categories
router.get("/categories/list", async (req, res) => {
  try {
    const templates = await db.select().from(vulnerabilityTemplates);
    
    // Extract unique categories
    const categories = [...new Set(templates.map((t) => t.category))];

    res.json({ categories });
  } catch (error) {
    console.error("Get categories error:", error);
    res.status(500).json({ error: "Failed to get categories" });
  }
});

export default router;
