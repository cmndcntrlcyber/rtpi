import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import VulnerabilityCard from '../../../../../client/src/components/vulnerabilities/VulnerabilityCard';

describe('VulnerabilityCard Component', () => {
  const mockVulnerability = {
    id: '1',
    title: 'SQL Injection',
    severity: 'high',
    status: 'open',
    description: 'SQL injection vulnerability found',
    targetId: 't-1',
    cvss: 8.5,
    discoveredAt: '2024-01-01T00:00:00Z',
  };

  describe('Rendering', () => {
    it('should render vulnerability card', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText('SQL Injection')).toBeInTheDocument();
    });

    it('should display title', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText('SQL Injection')).toBeInTheDocument();
    });

    it('should display severity badge', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText('HIGH')).toBeInTheDocument();
    });

    it('should display status badge', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText('open')).toBeInTheDocument();
    });

    it('should display description', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText('SQL injection vulnerability found')).toBeInTheDocument();
    });

    it('should display CVSS score', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.getByText(/8\.5/)).toBeInTheDocument();
    });
  });

  describe('Severity Display', () => {
    const severities = ['critical', 'high', 'medium', 'low', 'info'];

    severities.forEach(severity => {
      it(`should display ${severity} severity`, () => {
        const vuln = { ...mockVulnerability, severity };
        render(<VulnerabilityCard vulnerability={vuln} />);
        // Severity is displayed in uppercase
        expect(screen.getByText(severity.toUpperCase())).toBeInTheDocument();
      });
    });
  });

  describe('Status Display', () => {
    const statuses = ['open', 'investigating', 'remediated', 'accepted'];

    statuses.forEach(status => {
      it(`should display ${status} status`, () => {
        const vuln = { ...mockVulnerability, status };
        render(<VulnerabilityCard vulnerability={vuln} />);
        expect(screen.getByText(status)).toBeInTheDocument();
      });
    });
  });

  describe('Interactions', () => {
    it('should call onSelect when card is clicked', async () => {
      const onSelect = vi.fn();
      const user = userEvent.setup();
      
      render(<VulnerabilityCard vulnerability={mockVulnerability} onSelect={onSelect} />);
      
      const card = screen.getByText('SQL Injection').closest('div')?.parentElement?.parentElement;
      await user.click(card!);
      
      expect(onSelect).toHaveBeenCalledWith(mockVulnerability);
    });

    it('should call onEdit when edit button clicked', async () => {
      const onEdit = vi.fn();
      const user = userEvent.setup();
      
      render(<VulnerabilityCard vulnerability={mockVulnerability} onEdit={onEdit} />);
      
      const editButton = screen.getByText('Edit');
      await user.click(editButton);
      
      expect(onEdit).toHaveBeenCalledWith(mockVulnerability);
    });

    it('should call onDelete when delete button clicked', async () => {
      const onDelete = vi.fn();
      const user = userEvent.setup();
      
      render(<VulnerabilityCard vulnerability={mockVulnerability} onDelete={onDelete} />);
      
      const deleteButton = screen.getByText('Delete');
      await user.click(deleteButton);
      
      expect(onDelete).toHaveBeenCalledWith(mockVulnerability);
    });
  });

  describe('Action Buttons', () => {
    it('should show edit button when onEdit provided', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} onEdit={vi.fn()} />);
      expect(screen.getByText('Edit')).toBeInTheDocument();
    });

    it('should show delete button when onDelete provided', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} onDelete={vi.fn()} />);
      expect(screen.getByText('Delete')).toBeInTheDocument();
    });

    it('should not show buttons when no handlers provided', () => {
      render(<VulnerabilityCard vulnerability={mockVulnerability} />);
      expect(screen.queryByText('Edit')).not.toBeInTheDocument();
      expect(screen.queryByText('Delete')).not.toBeInTheDocument();
    });
  });
});
